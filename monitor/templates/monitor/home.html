{% extends "monitor/base.html" %}
{% block title %}Network Manager{% endblock %}

{% block content %}
<style>
    #context-menu {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        padding: 5px;
        border-radius: 5px;
        min-width: 150px;
    }

    #context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    #context-menu li {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        background: white;
    }

    #context-menu li:last-child {
        border-bottom: none;
    }

    #context-menu li:hover {
        background: #007bff;
        color: white;
    }

    #scan-status {
        font-size: 18px;
        margin: 20px 0;
        color: #007bff;
        animation: fadeInOut 1s infinite;
    }

    @keyframes fadeInOut {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    #topology-container {
        width: 100%;
        height: 400px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }
</style>
{% if not devices %}
<div class="text-center my-5">
    <h3>–ü—Ä–∏–≤–µ—Ç, –∞–¥–º–∏–Ω!</h3>
    <p>–ü–æ—Ö–æ–∂–µ, —Å–µ—Ç—å –µ—â—ë –Ω–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞. –ù–∞—á–Ω—ë–º?</p>
    <form id="scan-form" method="POST" action="{% url 'start_scan' %}">
        {% csrf_token %}
        <label for="start_ip">–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
        <input type="text" id="start_ip" name="start_ip" required>
        <label for="server_type">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞:</label>
        <input type="text" id="server_type" name="server_type" required>
        <label for="router_type">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞:</label>
        <input type="text" id="router_type" name="router_type" required>
        <label for="switch_type">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–∞:</label>
        <input type="text" id="switch_type" name="switch_type" required>
        <label for="client_type">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</label>
        <input type="text" id="client_type" name="client_type" required>
        <button type="submit" class="btn btn-primary mt-3">–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="scan-messages" class="mt-3"></div>
    </form>
</div>

{% else %}
<h3>–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Ç–æ–ø–æ–ª–æ–≥–∏—è</h3>
<div id="cy" style="height: 400px; border: 1px solid #ddd; margin-bottom: 20px;"></div>
<div id="context-menu" class="context-menu">
    <ul id="context-menu-list"></ul>
</div>
<button id="refreshTopology">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ø–æ–ª–æ–≥–∏—é</button>
<div id="legend">
    <span style="color: blue;">‚ñ†</span> –°–µ—Ä–≤–µ—Ä
    <span style="color: red;">‚ñ†</span> –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä
    <span style="color: green;">‚ñ†</span> –ö–æ–º–º—É—Ç–∞—Ç–æ—Ä
    <span style="color: orange;">‚ñ†</span> –ö–ª–∏–µ–Ω—Ç
    <span style="color: gray;">‚ñ†</span> –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π
</div>
<h3>–¢–∞–±–ª–∏—Ü–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h3>
<table class="table table-striped">
    <thead>
        <tr>
            <th>–ò–º—è</th>
            <th>–¢–∏–ø</th>
            <th>IP-–∞–¥—Ä–µ—Å–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
    </thead>
    <tbody>
        {% for device in devices %}
        <tr>
            <td>{{ device.name }}</td>
            <td>{{ device.device_type }}</td>
            <td>
                {% for interface in device.networkinterface_set.all %}
                {{ interface.ip_address }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                No IP Assigned
                {% endfor %}
            </td>
            <td>
                {% if device.is_online %}
                üü¢ Online
                {% else %}
                üî¥ Offline
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" class="text-center">–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>

<script>
    {% if topology_data %}
        const topologyData = {{ topology_data|safe }};
        console.log("–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–ø–æ–ª–æ–≥–∏–∏:", {{ topology_data|safe }});
        let cy = cytoscape({
            container: document.getElementById('cy'),
            elements: topologyData,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'color': 'white',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'background-color': 'data(color)',
                        'width': '50px',
                        'height': '50px'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle'
                    }
                }
            ],
            layout: {
                name: 'cose',
                animate: true
            }
        });

        console.log("–ì—Ä–∞—Ñ —Å–æ–∑–¥–∞–Ω:", cy);

        const deviceSettings = {
                router: [
                    { name: "Change IP Address", template: "change_ip" },
                    { name: "Create GRE Tunnel", template: "create_gre_tunnel" },
                    { name: "Set Default Route", template: "default_route" },
                ],
                server: [
                    { name: "Change IP Address", template: "change_ip" },
                    { name: "Configure DHCP", template: "configure_dhcp" },
                    { name: "Configure DNS", template: "configure_dns" },
                    { name: "Set Timezone", template: "set_timezone" },
                    { name: "Configure Chrony", template: "configure_chrony" },
                    { name: "Configure Ansible", template: "configure_ansible" },
                ],
                switch: [
                    { name: "Change IP Address", template: "change_ip" },
                ],
                client: [
                    { name: "Change IP Address", template: "change_ip" },
                ],
                unknown: [
                    { name: "Change IP Address", template: "change_ip" },
                ]
        };

        const contextMenu = document.getElementById('context-menu');
        const contextMenuList = document.getElementById('context-menu-list');

        // üìå –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —É–∑–ª—É (–æ—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é)
        cy.on('tap', 'node', (event) => {
            const node = event.target;
            const deviceId = node.data('id');
            const deviceType = node.data('device_type') || 'unknown';

            console.log(`–ö–ª–∏–∫ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É: ${node.data('label')} (ID: ${deviceId}, Type: ${deviceType})`);

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            contextMenuList.innerHTML = '';
            const settings = deviceSettings[deviceType] || [];

            settings.forEach(setting => {
                const li = document.createElement('li');
                li.textContent = setting.name;
                li.onclick = () => {
                    window.location.href = `/devices/${deviceId}/template/?template=${setting.template}`;
                };
                contextMenuList.appendChild(li);
            });
            contextMenu.style.top = `${event.renderedPosition.y + 10}px`;
            contextMenu.style.left = `${event.renderedPosition.x + 10}px`;
            contextMenu.style.setProperty('display', 'block', 'important');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è
            setTimeout(() => {
                contextMenu.style.display = 'block';
                console.log("–ü–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞ display:", window.getComputedStyle(contextMenu).display);
            }, 10);


            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ–Ω—è–ª—Å—è –ª–∏ display
            console.log("–°–≤–æ–π—Å—Ç–≤–æ display —É contextMenu:", window.getComputedStyle(contextMenu).display);
        });

        // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        document.addEventListener('click', (event) => {
            if (!contextMenu.contains(event.target)) {
                contextMenu.style.display = 'none';
            }
        });
        // üìå –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ø–æ–ª–æ–≥–∏–∏
        document.getElementById("refreshTopology").addEventListener("click", function () {
            fetch("{% url 'network_topology_data' %}")
                .then(response => response.json())
                .then(updatedData => {
                    cy.elements().remove();
                    cy.add(updatedData.nodes);
                    cy.add(updatedData.edges);
                    cy.layout({ name: 'cose' }).run();
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–æ–ª–æ–≥–∏–∏:", error));
        });
    {% endif %}


    document.getElementById('scan-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–ª–æ–∫–∞ scanMessages
        let scanMessages = document.getElementById('scan-messages');
        if (!scanMessages) {
            console.warn("–ë–ª–æ–∫ scan-messages –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            scanMessages = document.createElement('div');
            scanMessages.id = 'scan-messages';
            e.target.appendChild(scanMessages);  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —Ñ–æ—Ä–º—ã
        }
        const messages = [
        "–ò—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞... üïµÔ∏è",
        "–õ–æ–≤–∏–º –ø–∞–∫–µ—Ç—ã... üì°",
        "–ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã... üîç",
        "–ù–∞—Ö–æ–¥–∏–º –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã... üì¶",
        "–ö–∞–±–µ–ª—å –≤–æ—Ç–∫–Ω—É—Ç? ü™õ"
    ];
        scanMessages.innerHTML = '<p>' + messages[Math.floor(Math.random() * messages.length)] + '</p>';
        e.target.submit();
    });
</script>

{% endblock %}

